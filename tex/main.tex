\documentclass[]{article}
\usepackage[a4paper, total={6in, 8in}]{geometry}
\usepackage{pdflscape}
\usepackage{booktabs}
\usepackage{multicol}
\usepackage{mathtools, amssymb, amsmath}
\usepackage[
  sorting=nty,
  backend=bibtex,
  giveninits=true,
  style=authoryear-comp,
  natbib=true,
  maxcitenames=2,
  useprefix=true,
]{biblatex}
\bibliography{bibliography}

\newcommand{\todo}[1]{{\color{red}[\textit{TODO: #1}]}}
\newcommand{\todonocomment}[1]{{\color{red}[\textit{#1}]}}

\makeatletter
\newcommand{\citetnl}[1]{%
  \@firstofone{\citet{#1}}}
\makeatother

\input{tikz-setup.tex}

\title{Integrated Vehicle and Crew Scheduling for Electric Buses with Realistic Charging Behavior}
\date{July 2025}
\author{Thomas van der Plas, Han Hoogeveen, Philip de Bruin}
\begin{document}
\maketitle

\section{Introduction}
Electric vehicles are beginning to make up large portions of the fleet for public transport providers. In The Netherlands, approximately 21\% of all registered buses utilize an electric drivetrain, as reported by the \citet{RDW}. To comply with strict Dutch and the European \citet{europaRegulation20181999} on climate and sustainability, this proportion must increase substantially; from 2025 onward, the procurement of new buses powered by non-renewable energy sources will no longer be permitted, with the objective that by 2030, all public transport buses operate with zero emissions. Individual line operators such as \citet{qbuzzQbuzz} are therefore rapidly replacing their remaining combustion buses, resulting in primarily electric-powered fleets. \\
Effective use of these new electric vehicles is however more challenging than that of a combustion based fleet. One of the logistical steps in which this is most apparent is that of vehicle scheduling. The Vehicle Scheduling Problem (VSP) aims to assign vehicles such that a set of trips is covered; in the case of buses, these trips are defined by the timetables for individual lines. A typical solution to this problem comes in the form of a collection of vehicle tasks. A vehicle task can be seen as the schedule that an individual bus will follow throughout the day: it may start at a bus storage facility (more commonly called a depot), then perform one or more trips, before finally returning to the depot. In order to string multiple trips together, a bus must make an empty travel between the ending location of one trip to the starting location of the next. These empty travels, often called deadheads, are the main focus when determining the overall costs of a collection of vehicle tasks. There is ample choice as to which deadheads can be driven, as in theory the deadhead between each pair of compatible trips can be included during the creation of a vehicle task. It is therefore necessary to determine which of these deadheads are required to be driven such that costs are minimized. In addition, the total number of used vehicles may also be minimized. Different variants of the VSP exist, such as the having a single/multiple vehicle types or a single/multiple depots. \\
In each of these variants, a commonly made assumption is that a vehicle can travel an entire day without having to refuel. With electric vehicles, this assumption is often not valid: recharging throughout the day is required as the range of an electric vehicle is often quite limited. Additionally, recharging takes a long time when compared to the conventional refueling of a combustion vehicle; refueling can be done in a matter of minutes, whereas recharging may take multiple hours for a full charge. The electrification of fleets therefore requires the VSP to be adapted to include maximum range constraints, as well charging possibilities within a vehicle task. This extended version of the problem, often referred to as the Electric Vehicle Scheduling Problem (E-VSP), is significantly harder than its non-electric counterpart; the VSP with a single depot can be solved in polynomial time, whereas the E-VSP is NP-Hard as shown by \citet{Bunte2009} and \citet{Sassi2014} respectively. \\
In addition to this added computational complexity in the E-VSP, other logistical planning steps are effected as well. The Crew Scheduling Problem (CSP) is commonly the step that follows vehicle scheduling. Here, schedules are made for individual crew members such that the planned vehicles always have a driver associated with them. As crew members are subject to labor regulations, additional constraints are now added when compared to vehicle scheduling such as maximum driving time and required breaks. The CSP is also NP-Hard, as shown by and has been shown to be NP-Hard by \citet{Fischetti1989}.\\
Costs in this step often exceed those associated with the vehicles themselves, with a recent estimate by \citet{Perumal2019Crew} putting crew member costs at around 60\% of all operational costs. Optimal solutions for the CSP are however directly influenced by the selected vehicle tasks in the VSP; they determine where and at what time handovers are possible between crew members. Sequentially minimizing costs in the VSP and CSP may therefore not result in a solution with overall lowest costs, as the solution to the CSP may be improved greatly by incurring higher costs in the VSP. This was already pointed out in the 1980s by \citet{Bodin1983}, who instead advocated for an integrated approach; here, the VSP and CSP are considered at the same time, resulting in the Vehicle and Crew Scheduling Problem (VCSP). \\
A lot of work has already been done on the VSP, CSP and VCSP. Both the sequential and integrated approach have been extensively studied since the 1980s, as shown by reviews such as \citet{Ibarra-Rojas2015} and \citet{Ge2024}. The introduction of electric vehicles has however introduced significant constraints on charging and vehicle ranges, invalidating the critical assumption in many of the previous works that a vehicle was able to drive an entire day without being refueled. As a response to this, the E-VSP has also been the focus of many studies going back to around 2014. We refer the reader to a survey by \citet{Perumal2022LitRev} for a detailed overview of recent progress in that regard. \\
Only 5 works exist that consider the integrated VCSP with electric vehicles (E-VCSP). In these, simplifying assumptions are made which might limit real world applicability or accurate modeling of costs. Most notably, assumptions are currently made about charging locations (such as only being able to charge at a bus depot) or charging behavior (such as allowing full charges). \\
In this work, our aim is to introduce an integrated E-VCSP model which incorporates more realistic behavior for battery charging and usage. The rest of this work is organized as follows. In Section 2, we will give a more formal problem definition. In Section 3, we review literature related to the E-VCSP. \dots

\begin{table}
  \centering
  \begin{tabular}{ll}
    \toprule
    \multicolumn{1}{l}{\textbf{Abbreviation}} & \multicolumn{1}{l}{\textbf{Definition}}               \\
    \cmidrule(lr){1-1}\cmidrule(lr){2-2}
    ALNS                                      & Adaptive Large Neighborhood Search                   \\
    B\&P                                      & Branch-and-Price                                      \\
    CG                                        & Column Generation                                     \\
    CP                                        & Constraint Programming                                \\
    CSP                                       & Crew Scheduling Problem                               \\
    E-\dots                                   & Problem \dots with electric vehicles                  \\
    LNS                                       & Large Neighborhood Search                            \\
    LS                                        & Local Search                                          \\
    MDVSP                                     & Multi Depot Vehicle Scheduling Problem                \\
    MIP                                       & Mixed Integer Program                                 \\
    SAA                                       & Simulated Annealing Algorithm                         \\
    SDVSP                                     & Single Depot Vehicle Scheduling Problem               \\
    SoC                                       & State of Charge                                       \\
    TCO                                       & Total Cost of Ownership                               \\
    ToU                                       & Time of Usage                                         \\
    TVSP                                      & Integrated Timetabling and Vehicle Scheduling Problem \\
    VCSP                                      & Integrated Vehicle and Crew Scheduling Problem        \\
    VSP                                       & Vehicle Scheduling Problem                            \\
    \bottomrule
  \end{tabular}
  \label{tab:nomenclature}
  \caption{Nomenclature used in this work \todo{formatting}}
\end{table}

\section{Problem definition}
\label{sec:problem_def}
\todonocomment{Deze omschrijving is een versimpelde variant van het probleem zoals ik hem op het moment heb begrepen vanuit Qbuzz; naar mijn idee heb ik de hoofdlijnen nu uitgewerkt, maar een aantal constraints/mogelijkheden zijn nu nog niet toegevoegd. Ik denk dat deze versimpelde casus werkend krijgen de focus zal hebben voor de komende tijd, en dat deze uitbreiden gaandeweg kan worden gedaan als de tijd het toelaat. De volgende elementen zijn op dit moment nog niet (volledig) meegenomen: Capaciteit oplaadplekken (aantal plekken + totaal wattage), batterijgebruik tijdens wachttijd bus, personeel rustlocaties op loopafstand van elkaar (enige manier om van locatie te wisselen is door een bus rijden), tijdsgebonden elektriciteitsprijzen, kosten gebruikspatroon batterij, shiftpatronen (vroege/late diensten, gebroken shift). Daarnaast maak ik nu een versimpelende aanname dat laden alleen kan plaatsvinden vlak voordat je weggaat bij een deadhead/direct als je aankomt.} \\\\
In this section, we give a definition of the integrated electric vehicle and crew scheduling problem (E-VCSP). As mentioned in previous sections, our goal is to create minimum cost schedules for both vehicles and crew members; vehicle tasks must be constructed such that each trip is covered, and crew tasks must be constructed such that the vehicle tasks can be driven. Before defining these tasks, we first formally define the data which is given. A summary of the notation used throughout this section has been provided in Table \ref{tab:notation}. \\
Let $T$ be a set of trips that need to be driven, let $D$ be a set of depots that can be used, and let $L$ be a set of locations. A trip is defined as a travel between two locations in $L$; let $l_{t,start} \in L$ and $l_{t,end} \in L$ represent the starting and ending location of trip $t$ respectively, and let $l_d \in L$ represent the location of depot $d$. Next, let $p_{t,start}$ and $p_{t,end}$ refer to the planned starting and ending time of trip $t$, and let $d_t = p_{t,end} - p_{t,start}$ be the duration of the trip. Lastly, let $k_t$ be equal to the number of kilometers traveled during the trip. \\
As multiple vehicles types may be in use, let $\Phi$ represent the set of all vehicle types. For each trip $t$, a subset of these vehicle types $\phi_t \subseteq \Phi$ may be used in order to drive the trip. Each depot $d$ also has a preallocated number of each vehicle type available; let this be represented by $g^\phi_{d} \in \mathbb{N}^+$. Different vehicles might have different battery capacities; let $\sigma^\phi_{min}$ and $\sigma^\phi_{max}$ represent the minimum and maximum allowable SoC of vehicle type $\phi$, both expressed in KWh. Additionally, let $\sigma^\phi_{start}$ represent the capacity that a vehicle starts with at the beginning of a day, and let $c^\phi_t$ represent the amount of charge a vehicle of type $\phi$ would use when traveling the trip. \\
Now, let us define given metrics when traveling between different locations. As the exact travel between locations may differ depending on the time of day, we define these relations on a trip basis instead of location basis. Travels to and from depots are of course also allowed; let us therefore define these relations on some pair ($s,s'$) where $s$ and $s'$ must be either a trip or depot. Of these, at least one must be a trip, giving us a departure time. \\
Let $d_{s,s'}$ represent the duration of the drive between (the end of) $s$ and (start of) $s'$, adjusted for departure time. Similarly, let $k_{s, s'}$ represent the amount of kilometers traveled, and let $c^\phi_{s, s'}$ represent the amount of battery charge used. Note that this last metric is dependent on the vehicle type $\phi$, as different vehicle types might have different usage patterns. \\
Lastly, let us define our recharging behavior. In charging behavior, we make two key assumptions: firstly, we assume that it is only possible for a vehicle to charge between trips. Charging at a depot is therefore not directly modeled unless one of the trip locations is the depot itself. Secondly, we assume charging may only be done at the start of a deadhead; if charging is desired at the end of a deadhead instead, a dummy 0-duration trip must be introduced at the deadhead target to model this behavior. Using these two assumptions, we can determine a maximum amount of charge that can be added during a deadhead from $t$ to $t'$ while still allowing for travel between the two trips. \\
As charging is a nonlinear process, the starting SoC $\sigma$ of a vehicle at the end of $t$ is of importance. Additionally, charging speeds may differ depending on the vehicle type $\phi$. Combining this, we define $u^\phi_{\sigma,t,t'}$ as being this maximum possible amount of charge gained in the deadhead from $t$ to $t'$ while still allowing for travel between the trips. Note that when using discrete values for $\sigma$, all values of $u^\phi_{\sigma,t, t'}$ can be predetermined. In this, charging infrastructure available at $l_{t,end}$ must be considered considered. If no such infrastructure is available, $u^\phi_{\sigma,t, t'} = 0$. \\\\
Using these given values, we now start by formally defining a feasible vehicle task for a vehicle of type $\phi$. A vehicle task must start at a depot, then perform a sequence of compatible trips and charging actions, before finally returning to a depot. We refer to this ordered sequence as $S = \{ s_0, s_1, \dots, s_n, s_{n+1} \}$, where each step $s \in S$ can represent one of two actions: driving a trip $t \in T$, or being at a depot $d \in D$. In this sequence, let $a_s \in \{ depot, trip \}$ represent the specific action that is performed by $s$. In order for a sequence to be a feasible vehicle schedule, the following conditions must be met. \\
First, the vehicle must start at a depot, then perform a sequence of trips, before finally returning to the depot. Note that trips may have starting or ending locations that coincide with that of the depot, however their respective step is not considered to be a depot action.
\begin{align}
  a_{s_0} &= \text{depot} && \\
  a_{s_{n+1}} &= \text{depot} && \\ 
  a_{s_i} &= \text{trip} && \forall i = 1, \dots, n
\end{align}
The type of the vehicle must match those allowed for driving a trip. 
\begin{align}
  \phi &\in \phi_{t_i} && \forall i = 1, \dots, n
\end{align}
Trips may only be driven sequentially if there is time to travel from one trip to the next. Note that we make the assumption that there is always time to drive to and from a depot at the start and end of the day. 
\begin{align}
  p_{s_i,end} + d_{s_i, s_{i+1}} &\leq p_{s_{i+1},start} && \forall i = 1, \dots, n-1
\end{align}
Lastly, we want to ensure that the battery capacity is always respected. As mentioned before, the assumption is made that charging can only take place at the end of a trip before traveling to a following trip.
\begin{align}
  \sigma'_0 &= \sigma^\phi_{start} \\
  \sigma_{i} &= \sigma'_{i-1} - c^\phi_{s_{i-1}, s_{i}} - c_{s_{i}} && \forall i = 1, \dots, n + 1 \\
  \sigma_{i} &\geq \sigma^\phi_{min} && \forall i = 1, \dots, n + 1 \\
  \sigma'_{i} &= \sigma_{i} + \delta_j \cdot u^\phi_{\sigma_{i},s_{j}, s_{j+1}} && \forall i = 1, \dots, n \\
  \sigma'_{i} &\leq \sigma^\phi_{max} && \forall i = 1, \dots, n
\end{align}
Where $\sigma_i$ represents the SoC at the end of step $i$, and $\sigma'_i$ represents the SoC after possible charging is done at the end of step $i$. Additionally, $0 \leq \delta_i \leq 1$ represents a fraction of the maximum charge received. \\
For a feasible vehicle schedule $v$, let us define the following the following:
\begin{align}
  c(v) &= c(s_0, s_1) + \sum^{n}_{i = 1}(c(s_i) + c(s_i, s_i + 1))  \\
  d(v) &= d(s_0, s_1) + \sum^{n}_{i = 1}(d(s_i) + d(s_i, s_i + 1))  \\
  k(v) &= k(s_0, s_1) + \sum^{n}_{i = 1}(k(s_i) + k(s_i, s_i + 1))  \\
  cost(v) &= \alpha_1 + \alpha_2 \cdot c(v) + \alpha_3 \cdot d(v) + \alpha_4 \cdot k(v) 
\end{align}
Where $c(v)$, $d(v)$ and $k(v)$ represent the total charge used, active time and distance traveled, with some set of scalar values $\alpha$. We refer to the set of all feasible vehicle tasks which match these constraints as $V$. \\
Vehicle tasks can be split up into multiple segments, each of which must be performed continuously by a single crew member. In some cases, this can be a single trip; in other cases, it might not be possible for a driver to be replaced when arriving at the destination. Let $L_r \subseteq L$ be a subset of the locations at which the driver can be replaced; using these relief points as splitting points, for each vehicle task $v \in V$, let its set of segments be defined as $w(v)$; our overall set of of segments $W$ can then be defined as $W = \bigcup_{v \in V}w(v)$. In this, $w \in W$ represents a single segment. \\\\
Now, let us consider crew tasks. A crew task is defined as an ordered sequence of subtasks $E = \{ e_1, \dots, e_n \}$. Each of these subtasks may be of one of 5 types: driving a segment, taking a break, entering a vehicle; leaving a vehicle, or waiting in a vehicle. In order to differentiate between subtasks types, let the action performed during subtask $e$ be defined as $a_e \in \{\text{ drive, break, step-on, step-off, wait }\}$. For every subtask $e$, let us define $q_e$ as an identifier of the vehicle associated with the action. If $a_e = break$, $q_e$ is undefined. Additionally, let us define $l_{e,start}$ and $l_{e,end}$ as the starting and ending location of a subtask, and let $p_{e,start}$, $p_{e,end}$ be the starting and ending time. Similarly to trips $d_e = p_{e,end} - p_{e,start}$ be the duration of the subtask. Lastly, let $f_{l,on}$ and $f_{l,\textit{off}}$ represent the time needed in order to perform a step-on or step-off location at a location $l$. In order to keep notation concise, we also define $b(E) = \{ e \mid e \in E, a_e = break \}$ or the set of all break subtasks within a sequence.\\
In order for a sequence of subtasks to be a feasible crew task, the following conditions need to be met. We base our conditions on Dutch labor regulations, however similar regulations are present in other countries as well. \\ 
First, overall time feasibility. A driver may have a duty length of at most 9 hours. \\
\begin{align}
  p_{e_n,end} - p_{e_0,start} \leq 9\text{hours}
\end{align}
Next, break time feasibility. For shifts shorter than 4 hours, no breaks are required. For shifts between 4 and 5.5 hours, one break of at least 15 minutes must be included. For shifts longer than 5.5 hours, at least 40 minutes of break time must be included, where each individual break must be at least 15 minutes and at least one of these breaks must be 20 minutes or more. Lastly, for shifts starting after 15:00, a break between 16:30 and 20:30 of at least 20 minutes must be included. 
\begin{align}
  &\text{if } 4 \text{ hours} \leq p_{e_n,end} - p_{e_1,start} \leq 5.5 \text{ hours}&\text{ then} && \exists e \in b(E) : d_e \geq 15 \text{ min} \\
  &\text{if } 5.5 \text{ hours} \leq p_{e_n,end} - p_{e_1,start} &\text{ then} && \forall e \in b(E) : d_e \geq 15\text{ min } \land \\
  &&&& \exists e \in b(E) : d_e \geq 20 \text{ min } \land \\
  &&&& \sum_{e \in b(E)}d_e \geq 40 \text{ min} \\
  &\text{if } p_{e_1,start} \geq \text{15:00} &\text{ then} && \exists e \in b(E) : d_e \geq 20 \text{ min } \land \\
  &&&& \text{16:30} \leq p_{e,start} \leq \text{20:30} - p_{e,end}  \\
\end{align}
Next, we must ensure feasibility of transfers between subtasks themselves. In general, for waiting, break and handover related actions, the physical position of the driver does not change. For trips on the other hand, the starting position may differ from the ending position. In order to be feasible, each sequential pair of subtasks within the schedule must be reachable; additionally, the starting and ending location of the driver must be the same in order for the driver to return home at the end of the day.
\begin{align}
  && l_{e_n,end} = l_{e_1,start} && \\
  && l_{e_{i-1},start} = l_{e_i,end} && \forall i = 2, \dots, n \\
  \text{if } a_{e_i} \neq \text{trip} \text{ then } && l_{e_i,start} = l_{e_i,end} && \forall i = 1, \dots, n
\end{align}
A step-on or step-off subtask must be present in order for a driver to enter or exit a vehicle; without being in a vehicle, the corresponding segments may not be performed. Waiting may also not be performed without being in (or associated with) a vehicle. Note that the construction of our segments implicitly models the fact that drivers may only get on and off at designated locations; step-ons, step-offs and breaks are therefore always possible at segment ends.
\begin{align}
  \text{if } a_{e_i} &= \text{ drive}\text{ then} &&a_{e_{i-1}} \in \text{\{ wait, drive, step-on \}} \land q_{s_{i-1}} = q_{s_{i}} && \forall i = 2, \dots, n \\
  \text{if } a_{s_{i-1}} &= \text{ drive}\text{ then} &&a_{e_{i}} \in \text{\{ wait, drive, step-off \}} \land q_{s_{i-1}} = q_{s_{i}} && \forall i = 2, \dots, n \\
  \text{if } a_{s_{i}} &= \text{ wait}\text{ then} &&a_{e_{i-1}} \in \text{\{ drive, step-on \}} \land q_{s_{i-1}} = q_{s_{i}} && \forall i = 2, \dots, n
\end{align}
Step-on and step-off actions must also have a minimum duration; this time is dependent on the location at which the action is performed.
\begin{align}
  \text{if } a_{e_i} &= \text{ step-on}\text{ then} && d_{e} \geq f_{l_{e_i},on} && \forall i = 1, \dots, n \\
  \text{if } a_{e_i} &= \text{ step-off}\text{ then} && d_{e} \geq f_{l_{e_i},\textit{off}} && \forall i = 1, \dots, n \\
\end{align}
Lastly, the schedule must be continuous; the driver must always be performing one of the 5 specified actions, and must start with a step-on and end with a step-off.
\begin{align}
  a(s_1) &= \text{step-on} && \\
  a(s_n) &= \text{step-off} && \\
  e(s_i-1) &= s(s_i) && \forall i = 2, \dots, n \\
\end{align}
For a feasible crew schedule $c$, let us define its cost as being $cost(c) = \beta_1 + \beta_2 \cdot (p_{e_n,end} - p_{e_n,start}$, where $\beta$ is some set of scalar values representing the fixed and variable costs for a crew member respectively. Let the set of all feasible crew schedules be called $C$. \\\\
Now having our definitions of $V$, $W$ and $C$, we can formulate our integrated problem. In this, let $x_i$ and $y_j$ be binary variables indicate the usage of $v_i \in V$ and $c_j \in C$ respectively. Additionally, let $n_{it} \in \{ 0, 1 \}$ be a constant indicating that $v_i$ covers trip $t \in T$, and let with $m_{ijw} \in \{ 0, 1 \} $ indicate that trip $w \in w(v_i)$ is covered by crew task $j$. Now, our minimization is as follows:
\begin{align}
\min \quad
& \sum_{1 \leq i \leq |V|} x_{i}cost(v_i) + \sum_{1 \leq j \leq |C|} y_{j}cost(c_j)  
\end{align}
Subject to:
\begin{align}
\sum_{1 \leq i \leq |V|} x_{i}a^v_{it} &>= 1 && \forall t = 1,\:\dots,\:|T| \label{form:all-trips-covered} \\
\sum_{1 \leq j \leq |C|} y_{j}m_{ijw} &>= x_{i} && \forall i = 1,\:\dots,\:|V|, w \in w(v_i) \label{form:all-segments-covered} \\
x_{i} &\in \{ 0, 1 \} && \forall i = 1,\:\dots,\:|V| \\
y_{j} &\in \{ 0, 1 \} && \forall j = 1,\:\dots,\:|C|
\end{align}
Where (\ref{form:all-trips-covered}) ensures that all trips are covered by at least one vehicle, and (\ref{form:all-segments-covered}) ensures that the segments in used vehicle tasks are covered by corresponding crew tasks.

\begin{table}
  \centering
  \begin{tabular}{ll}
    \toprule
    \multicolumn{1}{l}{\textbf{Notation}} & \multicolumn{1}{l}{\textbf{Definition}}               \\
    \cmidrule(lr){1-1}\cmidrule(lr){2-2}
    \multicolumn{2}{l}{\textit{Given}} \\
    $v \in V$ & Set of all vehicle tasks, $v$ single vehicle task \\
    $w \in W$ & Set of all vehicle segments, $w$ single vehicle segment \\
    $v(w) \subseteq W$ & Set of vehicle segments for task $v$ \\ 
    $c \in C$ & Set of all crew tasks, $c$ single crew task \\
    $t \in T$ & Set of all trips, $t$ a single trip \\
    $d \in D$ & Set of all depots, $d$ a single depot \\
    $l \in L$ & Set of all locations, $l$ a single location \\
    $L_r \subseteq L$ & Set of relief locations \\ 
    $\phi \in \Phi$ & Set of vehicle types, $\phi$ a single type \\
    $\phi_t \subseteq \Phi$ & Set of compatible vehicle types for $t$ \\
    $g^\phi_{d} \in \mathbb{N}^+$ & Number of vehicles of type $\phi$ at $d$ \\
    $s \in S$ & Ordered sequence of vehicle steps, $s$ a single step \\ 
    $e \in E$ & Ordered sequence of crew subtasks, $e$ a single subtask \\ 
    $l_{\chi,start}$ & Starting location of $\chi$ \\
    $l_{\chi,end}$ & Ending location of $\chi$ \\ 
    $l_{\chi} $ & Location of $\chi$ \\
    $p_{\chi,start}$ & Planned starting time of $\chi$ \\
    $p_{\chi,end}$ & Planned end time of $\chi$ \\
    $d_{\chi}$ & Duration of $\chi$ \\ 
    $d_{\chi,\chi'}$ & Duration of drive between $\chi$ and $\chi'$ \\
    $k_{\chi}$ & Kilometers traveled in $\chi$ \\
    $k_{\chi,\chi'}$ & Kilometers driven between $\chi$ and $\chi'$ \\
    $c^\phi_{\chi}$ & SoC used by $\chi$ on type $\phi$ \\
    $c^\phi_{\chi,\chi'}$ & SoC used by $\phi$ driving between $\chi$ and $\chi'$ \\
    $\sigma^\phi_{min}$ & Minimum SoC of $\phi$ \\ 
    $\sigma^\phi_{max}$ & Maximum SoC of $\phi$ \\ 
    $\sigma^\phi_{start}$ & Starting SoC of $\phi$ \\ 
    $u^\phi_{\sigma,t,t'}$ & Max. SoC gained between $t$, $t'$ for type $\phi$, start SoC $\sigma$ \\
    $\delta$ & Fraction of maximum SoC gain used \\
    $a_\chi$ & Action type of sequence element $\chi$ \\
    $q_e$ & Vehicle associated with subtask $e$ \\
    $f_{l,on}$ & Step-on time at location $l$\\
    $f_{l,\textit{off}}$ & Step-off time at location $l$ \\
    $\alpha$ & Vector of cost scalars for vehicle tasks \\
    $\beta$ & Vector of cost scalars for crew tasks \\
    $n_{it} \in \{ 0, 1 \}$ & Vehicle task $v_i$ covers $t$ \\ 
    $m_{ijw} \in \{ 0, 1 \}$ & Crew task $c_j$ covers $w \in w(v_i)$ \\
    \addlinespace[0.6em]
    \multicolumn{2}{l}{\textit{Decision variables}} \\
    $x_{i} \in \{ 0, 1 \}$ & Usage of vehicle task $v_i$  \\ 
    $y_{j} \in \{ 0, 1 \}$ & Usage of crew task $c_j$ \\ 
    \addlinespace[0.6em]
    \multicolumn{2}{l}{\textit{Additional helper functions}} \\
    $d(v)$ & Total duration of $v$ \\ 
    $k(v)$ & Total kilometers traveled in $v$ \\ 
    $c(v)$ & Total charge used by $v$ \\ 
    $b(E)$ & Set of break actions in $E$ \\ 
    $cost(\chi)$ & Cost of task $\chi$ \\ 
    \addlinespace[0.2em]
    \bottomrule
  \end{tabular}
  \label{tab:notation}
  \caption{Notation used for formal problem description, where $\chi$ is used as a placeholder when multiple argument types can be applied. \todo{formatting paginanummer}}
\end{table}


\section{Related work}
In this section, we discuss work related to our research into the E-VCSP. An overview of the nomenclature used has been included in Table \ref{tab:nomenclature}, and an summary of how batteries and charging behavior is modeled in the discussed works has been included in Table \ref{tab:eVCSP-lit}.
\begin{landscape}
\null
\vfill
\begin{table}[h]
  \centering
  \begin{tabular}{llllllll}
    \toprule
                                     & Model   & ToU & SoC & Nonlinear Ch. & Partial Ch. & Ch. Location & Degradation \\
    \cmidrule(lr){2-8}
    \citet{Li2014}               & E-VSP   & No  & D   & No            & No          & D            & No          \\
    \Citet{vanKootenNiekerk2017} & E-VSP   & Yes & C/D & Yes           & Yes         & D/T          & Yes         \\
    \citet{Olsen2020}            & E-VSP   & No  & C   & Yes           & Yes         & D/T          & No          \\
    \citet{Zhang2021}            & E-VSP   & No  & C/D & Yes           & Yes         & D            & Yes         \\
    \citet{Parmentier2023}       & E-VSP   & No  & C   & Yes           & Yes         & D/T          & No          \\
    % \citet{Pulyassary2024}       & E-VSP   & No  & C/D & Yes           & Yes         & T            & No          \\
    \Citet{deVos2024}            & E-VSP   & No  & D   & Yes           & Yes         & D/T          & No          \\
    \addlinespace[0.4em]
    \citet{Perumal2021}          & E-VCSP  & No  & C   & No            & No          & D            & No          \\
    \citet{Wang2022}             & E-VCSP  & Yes & C   & No            & Yes         & D            & No          \\
    \citet{Sistig2023}           & E-VCSP  & No  & C   & No            & Yes         & D/T          & No          \\
    \citet{Shen2023}             & E-VCSP  & No  & C   & No            & No          & D/T          & No          \\
    \citet{Cong2024}             & E-VCSP  & Yes & C   & No            & Yes         & D            & No          \\
    \addlinespace[0.4em]
    \citet{Ham2021}              & E-VRPTW & Yes & C   & No            & Yes         & D            & No          \\
    \citet{Stadnichuk2024}       & E-TVSP  & No  & C   & No            & Yes         & D/T          & No          \\
    \bottomrule
  \end{tabular}
  \caption{A brief overview of battery modeling in E-VCSP related literature. SoC modeled as (D)iscrete or (C)ontinuous variable, Charge locations at (D)epot or (T)erminal trip stops, Degradation of battery in cost function}
  \label{tab:eVCSP-lit}
\end{table}
\vfill
\end{landscape}

\subsection{(E-)VSP}
Before considering previous work on the E-VSP, we first cover the most basic form of vehicle scheduling: that which only considers a single depot, single vehicle type and unlimited vehicle ranges. This problem, often referred to as the single depot vehicle scheduling problem (SDVSP), forms the underlying basis of both the multi-depot and electric vehicle extensions that we consider later. We therefore give a brief summary of one the most common models and solution methods used for the SDVSP, thereby having a baseline to which we can compare extensions. For a more comprehensive overview on different models used for the SDVSP and multi-depot VSP (MDVSP), we refer the reader to a review by \citet{Bunte2009}. \\
In order to find a solution the SDVSP, the problem can be transformed into one of finding a min-cost max-flow in a graph. The graph can be constructed as follows: For all trips $T$, add a pair of nodes representing the start and end of the trip respectively. Add an arc from the start of each trip to its end with capacity 1 and cost equal to that of driving the trip. Next, connect the end of each trip $t$ to the start of each trip $t'$ for which the deadhead between the two is feasible; that is, there is enough time to drive the deadhead from $t$ to $t'$ before the scheduled starting time of $t'$. Let each of these arcs have a capacity 1 and a cost equal to that of driving the deadhead from $t$ to $t'$. Lastly, let us introduce a pair of nodes representing the depot at the start and end of the day respectively. Connect the depot start node to the start of each trip, and do the same for the depot end node and the end of each trip. For each of these arcs, let the capacity once more be 1 and let the cost be equal to that of driving of the deadhead between the depot and trip. Fixed vehicle costs can be represented by adding costs to the arcs leaving the depot. \\
We can now find the min-cost max-flow on this graph; in this, let the depot start node be the source, and let de depot end node be the sink. Due to our construction, all trips must be covered by exactly 1 flow, resulting in flow paths which we can directly use as vehicle tasks due to the assumption that our vehicles have infinite range. It is therefore also shown that the SDVSP can be solved in polynomial time, as polynomial time min-cost max-flow algorithms exist and the graph elements are of size $|V| = O(|T|)$ and $|A| = O(|T|^2)$.\\ 
Two common extensions to the problem make it NP-Hard: the inclusion of multiple vehicle types, as well the use of multiple depots under the assumption that vehicles must return to their depot of origin. Both of these extensions are also discussed in \citet{Bunte2009}. The modification to the SDVSP flow network is the same in either case: an additional source/sink pair can be added for each new depot or vehicle type, and connected to the trips in the same way as the original depot. The problem then turns into into an integral multi-commodity flow, which has been shown to be NP-Hard by \citet{Even1975}. \\
The introduction of any resource constraints within the VSP has also been shown to be NP-Hard by
\citet{Bodin1983}. The E-VSP specifically deals with constraints on the driving range of vehicles, thereby making it closely related to the vehicle scheduling problem with route time constraints (VSP-RTC) as described by \citet{Haghani2002}. The key difference between these two problems is that the
E-VSP allows for (partial) recharging of a vehicle throughout the operating
period, whereas the VSP-RTC assumes a fixed maximum travel time for the
vehicle within the given period. The E-VSP has been shown to be NP-Hard by \citet{Sassi2014}. \\\\
\citet{Li2014} was one of the first to consider a solution method for the E-VSP. They consider a single-depot case with a single vehicle type, in which the assumption is made that full recharging (or battery swaps) can be performed in a fixed 5-minute time window. The model is based on an extension of the SDVSP network, with the inclusion of total driving time constraints. Additionally, time-discretized nodes are added to represent capacitated battery charging/swap stations. Connections are made from the trip nodes to the charging nodes when a travel between the two is feasible, allowing for a vehicle to perform one or more charging action during its task. By discretizing the nodes, charging station capacity is enforced by setting arc capacity to 1. For smaller instances, the model can be solved to optimality using column generation and branch-and-price (B\&P). For larger instances, an alternate approach using truncated column generation followed by a local search to find a local optimum is used instead. The proposed methods are tested on trips in the San Francisco Bay Area, with a maximum instance size of 242 trips. These tests resulted in optimality gaps of $<5\%$ for buses able to drive 150km, and between 7-15\%  for a range of 120km depending on the instance. \\
\Citet{vanKootenNiekerk2017} introduce two models which aim to solve the single depot E-VSP
while taking into account time dependent energy prices (ToU pricing), nonlinear charging times and
battery degradation due to depth of discharge. The first model only allows for linear charging and no consideration for degradation or ToU, but uses continuous state of charge (SoC) variables which are added to the SDVSP network. The second model does allow for the extra inclusions, achieving this by duplicating trip nodes in the SDVSP network for discrete SoC values. The second model is solved using column generation and lagrangian relaxation, resulting in a possibly non-optimal solution. Tests are performed using data provided by Belgian bus company De Lijn in the city Leuven, using a total of 543 trips. They show that the
discretized model can be solved in a considerably shorter time frame for large instances with similar results to
the continuous model. \\
\citet{Olsen2020} consider a multi-depot E-VSP, in which they model the nonlinear phase of charging as an exponential function. In order to solve, they propose a greedy heuristic to construct vehicle tasks. Their primary focus is comparing (piecewise) linear approximations for the second phase of charging with an exponential function based approximation. They conclude that SoC and required charging times are more comparable to real life behavior when using the exponential function. \\
\citet{Zhang2021} apply a similar method to the one found in \Citet{vanKootenNiekerk2017}. They consider a single depot with capacitated charging infrastructure,
with multiple round trip lines originating from the depot. In addition to this, they also incorporate nonlinear charging behavior and battery depreciation using discrete SoC and time nodes in the SDVSP network. They solve using a combination of CG and B\&P. Tests are done on both randomly generated instances as well as 6 not yet electrified lines with up to 160 and 197 trips
respectively.\\
\citet{Parmentier2023} consider a scalable approach to the E-VSP with non-linear charging. They introduce the concept of nondominated charging arcs, which are represented as deadhead arcs within the SDVSP. Their use considerably reduces the amount of candidate charging arcs when multiple charging points are available, as an arc is only considered if there is not another arc available with higher resulting charge and lower cost. In order to solve, a combination of CG and B\&P techniques are used. A more computationally efficient version of the pricing problem is also provided by the nondominated charging arcs when charging
infrastructure is uniform. Testing is done on the \textit{large}
instances introduced by \citet{Wen2016} which included up to 8
depots, 16 charging stations and 500 trips. Here, they are able to find
solutions that only have an 0.06\% optimality gap. \\
\Citet{deVos2024} consider the E-VSP with partial recharges and capacitated charging stations. Their model includes discrete SoC trip nodes and discrete SoC and time charging location nodes, similar to the models found in \citet{vanKootenNiekerk2017} and \citet{Zhang2021}. As with those models, power used during deadhead arcs is rounded up to the nearest discrete value; this results in an underestimation of the actual SoC of the vehicle during its task, however ensures solutions that can be feasibly driven. This pessimistically rounded graph, which De Vos et al. refer to as the primal network, is accompanied by a dual network; this . They solve the problem by applying CG with two separate approaches:
branch-and-price and a diving heuristic. To overcome the limitations of dual bounds resulting from a discretized model, they incorporate ideas from \citet{Boland2017} resulting in a dual network with optimistic connections. This gives the same bounds as the ones found in the
non-discretized model. Testing is performed on a bus concession south of
Amsterdam with 816 trips, with subsets being used as smaller instances.
Optimality gaps of 1.5-2.7\% are achieved across instances. They additionally
note that the framework as provided can easily be extended for nonlinear
charging functions and depth-of-discharge battery degradation. 

\subsection{CSP}
Given a solution to the (E-)VSP, the corresponding CSP is most often solved as a set partitioning (or set covering) problem. Here, the tasks described by the sequences of trips generated during vehicle scheduling must be covered by the individual schedules of crew members. This problem has been shown to be NP-Hard in general by \citet{Fischetti1989}.\\
Research into this subject is primarily done in the context of airline crew planning; crew costs in this field are generally even higher than those found in the more general public transport sector, as shown in \citet{Barnhart2003}. Additionally, strong labor unions and restrictive labor legislation due to safety concerns cause a large number of constraints to be applied to crew schedules, resulting in a non-trivial problem to solve. \\
Results achieved in the aviation space quite easily generalize to other sectors, and we therefore refer the reader to a recent review by \citet{Deveci2018} for an overview of the state of the art. 

\subsection{(E-)VCSP}
The VCSP has been a widely studied problem. Following the call for integrated methods by \citet{Bodin1983} and others in the 1980s, a large number of different methods has been applied to integrate the VSP and CSP. We refer the reader to a recent review by \citet{Ge2024} for a more general overview of work done in the field in the past years. \\
One work that we will individually highlight is that of \citet{Huisman2005}, due to its use of Lagrangian relaxation to connect the VSP and CSP . For readers unfamiliar with the technique, we recommend an introduction by \citet{Beasley1993}. Huisman et al. consider the multi-depot variant, and use a combination of CG and Lagrangian relaxation to solve both the MDVSP as well as the connection with the CSP. Of note is their assumption that crew members from each individual depot are only allowed to work on trips connected to said depot, allowing for individual depot CSPs to be solved as a subproblem. They test on instances in the Randstad metro area in the Netherlands with a maximum of 653 trips and 4 depots. \\\\
As for the electric counterpart of the VCSP, at time of writing we are aware of only five other works that discuss the integrated variant. \\
\citet{Perumal2021} were the first to offer a solution to the E-VCSP. They consider an instance of the problem in which only full recharges at the depot with a fixed duration of
120 minutes are possible. In order to solve, an ALNS was introduced which incorporates a B\&P heuristic
which has been previously used to solve the MDVSP, E-VSP and VCSP. The authors tested using real life data from lines in Denmark and Sweden with a
maximum instance size of 1109 trips and multiple depots, and report an improvement of $1.17-4.37\%$
across different instances when compared to a sequential approach. \\
\citet{Wang2022} introduce a two layered model using Particle Swarm Optimization and an
$\epsilon$-constraint based mechanism which allows for a mix of traditional
combustion and electric buses. The model incorporates partial
depot charging, as well as measures to ensure that crew is primarily assigned
to the same vehicle throughout the day. A circular bus route with a single
depot in Changchun, China with 68 daily trips is used as a basis for testing,
with a focus on electric versus diesel usage and driver satisfaction. \\
\citet{Sistig2023} also offered an ALNS based approach, which aimed to
improve upon the approach presented by \citet{Perumal2021} by including partial
recharges, opportunistic charging at terminal stops of trips and non-fixed
ranges for the vehicles. In order to solve, they implement a
selection of 3-step ALNS neighborhoods consisting of E-VSP modification,
finding a solution to the corresponding CSP and consequently modifying the CSP
solution. Tests were done using an instance of a city route in Germany, with a
single depot and a total of 282 trips. Different scenarios based on possible
crew break and relief locations were considered in order to compare diesel and
electric TCO. Additionally, sensitivity analysis of the TCO was done for
parameters such as costs for electricity and drivers. \\
\citet{Shen2023} provide a minimum-cost flow framework for the E-VSP which is
integrated with a set partitioning based approach for the E-CSP. They only provide full recharge capabilities at the depot,
however focus on the inclusion of a distinction between energy use when driving
and standing still in order to more accurately model real life traffic. A city
line in China with 270 daily trips and a single depot is used for testing,
resulting in cost savings of up to 8.7\% when compared to a sequential
approach. \\
\citet{Cong2024} provide a hybrid MIP and SAA based approach to optimizing a mixed
fleet of combustion and electric vehicles with ToU electricity pricing. In each SAA iteration, a collection of new E-VSP trip
assignments are created using neighborhood operations, after which two MIP
models are sequentially employed to solve for charging and crew schedules. The
methods are tested on a collection of 3 bus routes originating from the same
depot in Changchun City, China with a total of 520 trips across all routes.
When compared to the sequential approach, the integrated vehicle schedule was
able to reduce costs by 0.8\%. 

\subsection{Other related fields}
The VSP is closely related to the vehicle routing problem (VRP); in this problem, the aim is to find minimum cost routes for vehicles originating from a depot and needing to pass multiple stops, most commonly for pickup or delivery with capacity constraints. The extension of the E-VRP which includes arrival time windows (E-VRPTW) is most closely related to the E-VSP, as the use of 0-width windows allows us to define the same precedence constraints as those naturally defined by trips in the VSP. \\
An example of work done on the E-VRPTW is that of \citet{Ham2021}. They consider a single depot case in which they model ToU pricing and partial recharges during delivery routes. In order to model costs, a lexicographical minimization is done over the number of vehicles used, total distance traveled and energy recharged. In order to solve, a hybrid MIP and CP algorithm is used in which CP is used to model ToU related variables, and MIP is used to model the rest of the constraints. \\\\
Research has also been done into integrating the E-VSP with the step before it in the planning sequence: timetable planning. This problem, the E-TVSP, has recently been studied in the work of \citet{Stadnichuk2024}. They allowed results of the E-VSP to introduce optimality cuts into the MIP used for creating timetable plans, thereby reducing overall cost. This is achieved by transforming the E-VSP problem into one of bin packing with conflicts, after which three different heuristic methods are applied and compared. They additionally prove that the bounds of the used heuristics are tight for their given instances. 

\begin{figure}[ht]
  \centering
  \begin{tikzpicture}[node distance=2cm]
    \node (strategic) [process, minimum height=2.3cm] {\textbf{Strategic planning}\\\textit{Long term}};
    \node at (strategic.base) (infra) [subprocess, xshift=2.8cm, yshift=0.4cm] {Infrastructure};
    \node at (strategic.base) (line) [subprocess, below of=infra, yshift=1cm] {Line planning and frequency};

    \node (tactical) [process, minimum height=4.5cm, below of=strategic, yshift=-2cm] {\textbf{Tactical planning}\\\textit{Medium-Long term}};
    \node at (tactical.base) (timetable) [subprocess, xshift=2.8cm, yshift=1.5cm] {Timetabling};
    \node at (tactical.base) (vehicle) [subprocess, below of=timetable, yshift=1cm] {Vehicle scheduling (VSP)};
    \node at (tactical.base) (crew) [subprocess, below of=vehicle, yshift=1cm] {Crew scheduling (CSP)};
    \node at (tactical.base) (VCSP) [rounded corners, draw=black, fit=(vehicle) (crew), align=left] {\hspace{-4em}VCSP};
    \node at (tactical.base) (rostering) [subprocess, below of=crew, yshift=1cm] {Crew rostering};

    \node (operational) [process, minimum height=1.3cm, below of=tactical, yshift=-1.5cm] {\textbf{Operational planning}\\\textit{Day of operations}};
    \node at (operational.base) (recovery) [subprocess, xshift=2.8cm, yshift=-0.1cm] {Recovery};

    \draw [arrow] (infra) -- (line);
    \draw [arrow] (line) -- (timetable);
    \draw [arrow] (timetable) -- (vehicle);
    \draw [arrow] (vehicle) -- (crew);
    \draw [arrow] (crew) -- (rostering);
    \draw [arrow] (rostering) -- (recovery);
  \end{tikzpicture}
  \caption{A general overview of the public transport planning process, based on \citet{Ceder1986, Ibarra-Rojas2015, Perumal2022LitRev}.}
  \label{fig:planning-overview}
\end{figure}

\section{Rough planning}
The following constraints list of constraints seem to make the problem the most challenging (when compared to a single-depot single-vehicle type combustion based model): Partial charges, Nonlinear charges, Capacitated charging stations, Multiple vehicle types and Multiple depots. \\
Partial and nonlinear charges can both be solved by using a similar discrete model as the one used in \Citet{vanKootenNiekerk2017}, \citet{Zhang2021} or \Citet{deVos2024}; all of these allow for handling of partial and nonlinear in the charging deadhead arcs, and battery degradation costs/ToU pricing could be included during vehicle task column generation. As all of these basically come for free with the choice of modeling, it would seem wise to focus on getting this working with a single depot / single vehicle type instance first. \\
Next, the issue of multiple vehicle types and depots. Both of these can be approached in roughly the same manner, however from conversations with Qbuzz it would seem that vehicle types should be done first as even the smallest instance provided to me now uses multiple vehicle types. Here, an approach similar to that found in \citet{Huisman2005} might be adaptable. \\
Lastly, the addition of capacitated charging stations is an issue. In both \citet{Zhang2021} and \Citet{deVos2024}, this is handled however only the number of individual charging spots is constrained; total charging power available is also constrained in the Qbuzz context. I'm unsure of how to easily integrate this into a discretized model at time of writing without underestimating total power available, and doing so would probably require some pretty drastic changes to the model as a whole. \\
In conclusion, my personal guess is that the following list of priorities is the best going forward:
\begin{itemize}
  \item Begin with implementing an adaptation of one of the previously mentioned models (probably a combination of \Citet{vanKootenNiekerk2017} and \Citet{deVos2024}) in order to get solutions to the E-VSP which incorporate partial charging, nonlinear charging and battery degredation.
  \item Add extraction of task blocks for crew scheduling, link with a set cover approach to crew scheduling.
  \item Expand model to include multiple vehicle types/depots.
  \item Expand model to include charging capacity (if time allows).
\end{itemize}
A rough planning has been outlined in Table \ref{tab:planning}. At time of writing I'm very unsure of the exact time required for each implementation step as this is my first time implementing most of the relevant techniques, so I've tried to leave some buffer room.
\begin{table}[h]
  \centering
  \begin{tabular}{ll}
    \toprule
    \multicolumn{1}{l}{\textbf{Date}} & \multicolumn{1}{l}{\textbf{Task description}}               \\
    \cmidrule(lr){1-1}\cmidrule(lr){2-2}
    Mid February & Finalize project proposal \\
    Mid February - End March & Implementation of E-SDVSP \\
    Begin April - End April & Link E-SDVSP with crew scheduling \\ 
    Begin May - Mid May & Testing with E-SDVCSP, report findings, draft \\
    Mid May - End May & Buffer \\ 
    Start June - End June & Extend to include multi-vehicle/multi-depot constraints \\
    Start July - Mid July & Testing with E-MDVCSP, report findings, draft \\ 
    Mid July - End July & Finalize report, prepare final presentation \\ 
    Start August & Finalize project \\
    If time available & Charging station capacities \\
    \bottomrule
  \end{tabular}
  \label{tab:planning}
  \caption{Rough outline of planning}
\end{table}

\printbibliography
\end{document}