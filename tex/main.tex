\documentclass[]{article}
\usepackage[a4paper, total={6in, 8in}]{geometry}
\usepackage{pdflscape}
\usepackage{booktabs}
\usepackage{multicol}
\usepackage{mathtools, amssymb, amsmath}
\usepackage[
  sorting=none,
  sortcites=true,
  backend=bibtex,
  giveninits=true,
  style=authoryear-comp,
  natbib=true,
  maxcitenames=2,
]{biblatex}
\bibliography{bibliography}

\newcommand{\todo}[1]{{\color{red}[\textit{TODO: #1}]}}

\makeatletter
\newcommand{\citetnl}[1]{%
  \@firstofone{\citet{#1}}}
\makeatother

\input{tikz-setup.tex}

\title{Integrated Vehicle and Crew Scheduling for Electric Buses with Realistic Charging Behavior}
\date{July 2025}
\author{Thomas van der Plas, Han Hoogeveen, Philip de Bruin}
\begin{document}
\maketitle

\section{Introduction}
Electric vehicles are beginning to make up large portions of the fleet for
public transport providers. In The Netherlands for instance, around 21\% of all
registered buses are already electric according to the \citet{RDW}. However,
in order to meet \citet{europaRegulation20181999} on climate and sustainability, individual
line operators such as the Dutch \citet{qbuzzQbuzz} are slowly replacing even more of their old
combustion based fleet with electric vehicles. It is therefore almost certain that this share will only grow in
coming years across different countries. \\
This shift in energy source has introduced new challenges to the methods currently in use to keep our public transport moving. Of primary concern are charging infrastructure and vehicle ranges, both of which are much more limited than their traditional combustion based counterparts. The planning process which has traditionally been used, as outlined in Figure \ref{fig:planning-overview}, therefore requires additional research into each of its steps in order to incorporate these newly relevant constraints.\\
\noindent In this work, we will focus on incorporating electric vehicle restrictions into two of these steps: vehicle scheduling and crew scheduling. Specifically, we will consider the scheduling of electric buses and their drivers, as these two steps make up a majority of day-to-day costs within the bus transit sector. \\
\begin{figure}[ht]
  \centering
  \begin{tikzpicture}[node distance=2cm]
    \node (strategic) [process, minimum height=2.3cm] {\textbf{Strategic planning}\\\textit{Long term}};
    \node at (strategic.base) (infra) [subprocess, xshift=2.8cm, yshift=0.4cm] {Infrastructure};
    \node at (strategic.base) (line) [subprocess, below of=infra, yshift=1cm] {Line planning and frequency};

    \node (tactical) [process, minimum height=4.5cm, below of=strategic, yshift=-2cm] {\textbf{Tactical planning}\\\textit{Medium-Long term}};
    \node at (tactical.base) (timetable) [subprocess, xshift=2.8cm, yshift=1.5cm] {Timetabling};
    \node at (tactical.base) (vehicle) [subprocess, below of=timetable, yshift=1cm] {Vehicle scheduling (VSP)};
    \node at (tactical.base) (crew) [subprocess, below of=vehicle, yshift=1cm] {Crew scheduling (CSP)};
    \node at (tactical.base) (VCSP) [rounded corners, draw=black, fit=(vehicle) (crew), align=left] {\hspace{-4em}VCSP};
    \node at (tactical.base) (rostering) [subprocess, below of=crew, yshift=1cm] {Crew rostering};

    \node (operational) [process, minimum height=1.3cm, below of=tactical, yshift=-1.5cm] {\textbf{Operational planning}\\\textit{Day of operations}};
    \node at (operational.base) (recovery) [subprocess, xshift=2.8cm, yshift=-0.1cm] {Recovery};

    \draw [arrow] (infra) -- (line);
    \draw [arrow] (line) -- (timetable);
    \draw [arrow] (timetable) -- (vehicle);
    \draw [arrow] (vehicle) -- (crew);
    \draw [arrow] (crew) -- (rostering);
    \draw [arrow] (rostering) -- (recovery);
  \end{tikzpicture}
  \caption{A general overview of the public transport planning process, based on \citet{Ceder1986, Ibarra-Rojas2015, Perumal2022LitRev}.}
  \label{fig:planning-overview}
\end{figure}
The goal of vehicle scheduling is generally to assign vehicles such that a set of trips is covered. In the case of buses, trips are given by the timetables for the individual routes as generated in the previous planning step. Our goal is therefore to assign sequences of compatible trips to buses such that each individual trip is driven. \\
In order to do this, a collection of vehicle tasks must be generated. A vehicle task can be seen as the individual schedule that a bus will follow throughout the day: it may start at a bus storage facility (more commonly called a depot), then perform one or more trips, before finally returning to the depot. The driving actions performed between between a depot and a trip, as well as those between trips themselves are called deadheads. The costs of driven deadheads along with the total number of buses used are the main focus for minimization, as the costs incurred for driving the trips themselves are fixed. This cost minimization problem is often referred to as the vehicle scheduling problem or VSP. The single-depot VSP with a single vehicle type is solvable in polynomial time, however extensions such as multiple vehicle types or limited vehicle ranges are shown to be NP-Hard by \citet{Bunte2009} and \citet{Haghani2002} respectively. \\
Once vehicle tasks are known, we can move on to scheduling our crew. Here, our goal is to find an assignment of crew members to vehicles  such that the previously made vehicle tasks can actually be performed. Continuing within the context of bus planning, we now need to match drivers with our previously planned buses such that there is always a driver present while the bus is moving. In order to do this, a set of crew tasks must be created that completely cover the given vehicle tasks. \\ 
A one-to-one mapping between crew tasks and vehicle tasks is not always possible; overall driving time for a driver is limited in a single day due to labor regulations, and for longer shifts breaks are mandatory as well. As vehicles don't have these constraints, a vehicle task may not be feasible to perform in its entirety for a single driver. It is therefore necessary to split vehicle tasks up into multiple segments, whereafter we can create crew tasks that consist of a sequence of one or more compatible segments. The costs of vehicle tasks themselves are fixed as they must always be driven; in order to minimize costs, we must therefore find a covering set of crew tasks which minimizes the number of required crew members and paid hours in which the driver is not actively driving. This minimization problem is referred to as the crew scheduling problem or CSP, and has been shown to be NP-Hard by \citet{Fischetti1989}. \\ 
Crew scheduling is the greatest contributor to day-to-day costs; a recent estimate by \citet{Perumal2019Crew} puts it at around 60\% of the overall operational costs for bus transit providers in Northern Europe. As can be seen however, the VSP and CSP are very closely related. The vehicle tasks that are selected in the VSP directly determine what crew
tasks are feasible within the CSP. It is therefore not always optimal to
fully minimize costs in the vehicle scheduling process, as this might incur
higher overall costs due to crew scheduling. We can therefore roughly split the
solving of vehicle and crew assignments into two separate approaches:
sequential, in which the VSP and CSP are solved separately; or integrated, in
which the VSP and CSP are solved such that overall costs are minimized
simultaneously. The integrated approach is often referred to as the vehicle and
crew scheduling problem, or VCSP. \\
A lot of work has already been done for the VSP, CSP and VCSP.
Both the sequential and integrated approach have been extensively studied since the 1980s, as shown by surveys such as \citet{Bodin1983}. The introduction of electric vehicles has however introduced significant constraints on charging and vehicle ranges, invalidating a formerly often made assumption that a vehicle was able to drive an entire day without being refueled. This most directly effects the VSP, as charging periods now need to be added throughout the day in order to
effectively use buses. The version of the vehicle scheduling problem which incorporates these constraints, referred to as the
E-VSP, has been the focus of many studies going back to around 2014. We refer the reader
to a survey by \citet{Perumal2022LitRev} for a detailed overview of recent progress. \\
Limited literature does exist on the integrated VCSP with electric vehicles (E-VCSP), however
simplifying assumptions are made which might limit real world applicability or
accurate modeling of costs. Most notably, assumptions are currently made about charging
locations (such as only being able to charge at a bus depot) or charging
behavior (such as modeling the process as being purely linear or only allowing
full charges). Additionally, to the best of our knowledge battery degradation
due to usage patterns has not been included in any integrated models at the
time of writing. Our aim is to introduce an integrated E-VCSP model which incorporates more realistic behavior for battery charging and usage, by including the following:
\begin{itemize}
  \item Nonlinear battery charging times.
  \item Cost of battery degradation due to usage patterns.
  \item Capacitated charging stations at both depots and the endpoints of a trip.
  \item Partial charging of the battery throughout the day.
\end{itemize}
Using this model, we compare the overall costs of the integrated approach to an equivalent sequential formulation using instances provided by Qbuzz. \todo{Alleen kosten vergelijken lijkt me met minimale doel; Het liefst zou ik ook nog iets van gevoeligheidsanalyse doen voor invloed van oplaadlocaties/batterijcapaciteit/etc, maar dat is afhankelijk van hoeveel tijd het model werkend krijgen kost}. \\  
This work is organized as follows. In Section 2, we will discuss work related to the E-VCSP and give an overview of common ways of modeling and solving the problem. In Section 3, we give our formal problem definition.\ \todo{Meer secties}.

% We will now give an informal overview of the
% problems at hand. A more formal definition can be found in Section
% \ref{sec:problem_def} \todo{work in progress}. \\
% The Vehicle Scheduling Problem (VSP) aims to find a set
% of minimum cost vehicle tasks such that all trips that need to be driven
% throughout a time period are covered. In this, a trip is defined as full or
% partial travel of a vehicle along a predetermined route, and a vehicle task is
% defined as a set of sequential operations that a vehicle will perform. A task for a
% vehicle must start at a depot, perform a number of compatible trips (that is,
% trips which can be performed sequentially while respecting driving times
% between trips), before finally returning to its original depot. In order to
% minimize operational costs, both the number of used vehicles and the overall driven
% distance between trips need to be minimized. \\ The VSP
% with a single depot and unconstrained vehicle ranges can be solved in
% polynomial time \citet{Freling2003SDVSP}. The multi-depot variant of the problem
% on the other hand is known to be NP-Hard, and the addition of constrained vehicle ranges such as those found
% in EVs also make the problem NP-Hard \citet{Bodin1983}. We will consider a
% general depot case with constrained vehicle ranges due to the inclusion of EVs,
% and will therefore refer to the VSP as being NP-Hard. \\\\ The Crew
% Scheduling Problem (CSP) on the other hand aims to find a minimum cost
% assignment of crew members to vehicle tasks. Given a set of vehicle tasks and
% crew members, the goal is to find an assignment of crew members such that each
% vehicle is always driven by at least one driver. In this, constraints such as
% maximum working time on a day, driver breaks and handovers between different
% drivers on the same vehicle need to be considered. The primary goal for
% minimization here is the total number of workers needed and hours worked. The
% CSP is also known to be an NP-Hard problem \citet{Fischetti1989}.\\\\ As can be seen, the VSP and CSP are closely related.  

\begin{table}
  \centering
  \begin{tabular}{ll}
    \toprule
    \multicolumn{1}{l}{\textbf{Abbreviation}} & \multicolumn{1}{l}{\textbf{Definition}}               \\
    \cmidrule(lr){1-1}\cmidrule(lr){2-2}
    ALNS                                      & Adaptive Large Neighborhood Search                   \\
    B\&P                                      & Branch-and-Price                                      \\
    CG                                        & Column Generation                                     \\
    CP                                        & Constraint Programming                                \\
    CSP                                       & Crew Scheduling Problem                               \\
    E-\dots                                   & Problem \dots with electric vehicles                  \\
    LNS                                       & Large Neighborhood Search                            \\
    LS                                        & Local Search                                          \\
    MDVSP                                     & Multi Depot Vehicle Scheduling Problem                \\
    MIP                                       & Mixed Integer Program                                 \\
    SAA                                       & Simulated Annealing Algorithm                         \\
    SDVSP                                     & Single Depot Vehicle Scheduling Problem               \\
    SoC                                       & State of Charge                                       \\
    TCO                                       & Total Cost of Ownership                               \\
    ToU                                       & Time of Usage                                         \\
    TVSP                                      & Integrated Timetabling and Vehicle Scheduling Problem \\
    VCSP                                      & Integrated Vehicle and Crew Scheduling Problem        \\
    VSP                                       & Vehicle Scheduling Problem                            \\
    \bottomrule
  \end{tabular}
  \label{tab:nomenclature}
  \caption{Nomenclature used in this work}
\end{table}

\section{Related work}
In this section, we will discuss work related to our research into the E-VCSP. An overview of the nomenclature used has been included in Table \ref{tab:nomenclature}, and an summary of how batteries and charging behavior is modeled in the discussed works has been included in Table \ref{tab:eVCSP-lit}.
\begin{landscape}
\null
\vfill
\begin{table}[h]
  \centering
  \begin{tabular}{llllllll}
    \toprule
                                     & Model   & ToU & SoC & Nonlinear Ch. & Partial Ch. & Ch. Location & Degradation \\
    \cmidrule(lr){2-8}
    \citet{Li2014}               & E-VSP   & No  & D   & No            & No          & D            & No          \\
    \citet{vanKootenNiekerk2017} & E-VSP   & Yes & C/D & Yes           & Yes         & D/T          & Yes         \\
    \citet{Olsen2020}            & E-VSP   & No  & C   & Yes           & Yes         & D/T          & No          \\
    \citet{Zhang2021}            & E-VSP   & No  & C/D & Yes           & Yes         & D            & Yes         \\
    \citet{Parmentier2023}       & E-VSP   & No  & C   & Yes           & Yes         & D/T          & No          \\
    % \citet{Pulyassary2024}       & E-VSP   & No  & C/D & Yes           & Yes         & T            & No          \\
    \citet{deVos2024}            & E-VSP   & No  & D   & Yes           & Yes         & D/T          & No          \\
    \addlinespace[0.4em]
    \citet{Perumal2021}          & E-VCSP  & No  & C   & No            & No          & D            & No          \\
    \citet{Wang2022}             & E-VCSP  & Yes & C   & No            & Yes         & D            & No          \\
    \citet{Sistig2023}           & E-VCSP  & No  & C   & No            & Yes         & D/T          & No          \\
    \citet{Shen2023}             & E-VCSP  & No  & C   & No            & No          & D/T          & No          \\
    \citet{Cong2024}             & E-VCSP  & Yes & C   & No            & Yes         & D            & No          \\
    \addlinespace[0.4em]
    \citet{Ham2021}              & E-VRPTW & Yes & C   & No            & Yes         & D            & No          \\
    \citet{Stadnichuk2024}       & E-TVSP  & No  & C   & No            & Yes         & D/T          & No          \\
    \bottomrule
  \end{tabular}
  \caption{A brief overview of battery modeling in E-VCSP related literature. SoC modeled as (D)iscrete or (C)ontinuous variable, Charge locations at (D)epot or (T)erminal trip stops, Degradation of battery in cost function}
  \label{tab:eVCSP-lit}
\end{table}
\vfill
\end{landscape}

\todo{uitleg van de SDVSP}
\subsection{(E-)VSP}
Before considering previous work on the E-VSP, we will first cover the most basic form of vehicle scheduling: that which only considers a single depot, single vehicle type and unlimited vehicle ranges. This problem, referred to as the single depot vehicle scheduling problem (SDVSP), forms the underlying basis of both the multi-depot and electric vehicle extensions that we will consider later. We will therefore give a brief summary of one the most common models and solution methods used for the SDVSP, thereby having a baseline to which we can compare extensions. For a more comprehensive overview on different models used for the SDVSP and multi-depot VSP (MDVSP), we refer the reader to a review by \citet{Bunte2009}. \\
As mentioned before, our goal in the SDVSP is to create a set of vehicle tasks throughout the day in which the number of vehicles and the cost of driven deadheads is minimized while covering all trips. In order to solve this problem, a graph consisting of the trips and depot can be created. In this graph, we can then solve a min-cost flow problem in which all trips are covered; the optimal vehicle tasks then follow from the flow paths along the trips. \\
More formally, given a set of trips $T$ and a single depot $d$, a graph $G = (V, A)$ can be constructed. Let $V = \{ v^s_t \mid t \in T \} \cup \{ v^e_t \mid t \in T \} \cup \{ v^s_d, v^e_d \}$, in which each pair of nodes $(v^s_t, v^e_t)$ represent the start and end of trip $t$ respectively. Additionally, the pair of nodes $(v^s_d, v^e_d)$ represent the depot at the start and end of the day. Next, let $A_T = \{ (v^s_t, v^e_t) \mid t \in T \}$ represent the arcs connecting the start and end of the trip, each with cost equal to the cost of driving the trip. Let $A_{DH} = \{ ( v^e_t,\: v^s_{t'}) \mid (t, t') \in T \times T,\: t'\text{ can be driven after }t \}$ represent a set of arcs which model feasible deadhead trips; once again, each with cost equal to those incurred when driving the deadhead between $t$ and $t'$. Let $A_{D} = \{ (v^s_d, v^s_t) \mid t \in T \} \cup \{ (v^e_t, v_d^e) \mid t \in T \}$ represent deadheads from the depot to a trip and vice versa, once again with costs equal to those when driving the deadheads. If fixed costs per vehicle are required, these can be added to arcs leaving the depot. Finally, let $A = A_T \cup A_{DH} \cup A_D$, and let all arcs have capacity equal to 1. \\
Setting $v^s_d$ as our source and $v_d^e$ as our sink, we can now find a min-cost max-flow across the graph $G$. Due to our construction, all trips must be covered by exactly 1 flow, resulting in flow paths which we can directly use as vehicle tasks due to the assumption that our vehicles have enough range. It is therefore also shown that the SDVSP can be solved in polynomial time, as polynomial time min-cost max-flow algorithms exist and the graph elements are of size $|V| = O(|T|)$ and $|A| = O(|T|^2)$.\\
Two common extensions to the problem make it NP-Hard: the inclusion of multiple vehicle types, as well the use of multiple depots under the assumption that vehicles must return to their depot of origin. Both of these extensions are also discussed in \citet{Bunte2009}. The modification to the SDVSP flow network is the same in either case: an additional source/sink pair can be added for each new depot or vehicle type, and connected to the trips in the same way as the original depot. The problem then turns into into an integral multi-commodity flow, which has been shown to be NP-Hard by \citet{Even1975}. \\
The introduction of any resource constraints within the VSP has also been shown to be NP-Hard by
\citet{Bodin1983}. The E-VSP specifically deals with constraints on the driving range of vehicles, thereby making it closely related to the vehicle scheduling problem with route time constraints (VSP-RTC) as described by \citet{Haghani2002}. The key difference between these two problems is that the
E-VSP allows for (partial) recharging of a vehicle throughout the operating
period, whereas the VSP-RTC assumes a fixed maximum travel time for the
vehicle within the given period. The E-VSP has been shown to be NP-Hard by \citet{Sassi2014}. \\\\
\citet{Li2014} was one of the first to consider a solution method for the E-VSP. A single-depot case with a single vehicle type is considered, in which the assumption is made that recharging (or battery swaps) can be performed in a fixed 5-minute window. The model is based on an extension of the SDVSP network, with the inclusion of total driving time constraints. Additionally, extra time-discretized nodes are added to represent capacitated battery charging/swap stations. For smaller instances, the model can be solved to optimality using column generation and branch-and-price (B\&P). For larger instances, an alternate approach using truncated column generation followed by a local search to find a local
optimum is used instead. The proposed methods are tested on trips in the San Francisco Bay
Area, with a maximum instance size of 242 trips. These tests resulted in
optimality gaps of $<5\%$ for buses able to drive 150km, and between 7-15\%
for a range of 120km depending on the instance. \\
\citetnl{vanKootenNiekerk2017} introduces two models which aim to solve the single depot E-VSP
while taking into account time dependent energy prices (ToU pricing), nonlinear charging times and
battery degradation due to depth of discharge. The first model only allows for linear charging and no consideration for degradation or ToU, but uses continuous state of charge (SoC) variables which are added to the SDVSP network. The second model does allow for the extra inclusions, achieving this by duplicating trip nodes in the SDVSP network for discrete SoC values. The second model is solved using column generation and lagrangian relaxation, resulting in a possibly non-optimal solution. Tests are performed using data provided by Belgian bus company De Lijn in the city Leuven, using a total of 543 trips. They show that the
discretized model can be solved in a considerably shorter time frame for large instances with similar results to
the continuous model. \\
\citet{Olsen2020} consider a multi-depot E-VSP, in which they which model the nonlinear phase of charging as an exponential function. In order to solve, they propose a greedy heuristic to construct vehicle tasks. Their primary focus is comparing (piecewise) linear approximations for the second phase of charging with an exponential function based approximation. They conclude that SoC and required charging times are more comparable to real life behavior when using the exponential function. \\
\citet{Zhang2021} apply a similar method to the one found in \Citet{vanKootenNiekerk2017}. They consider a single depot with capacitated charging infrastructure,
with multiple round trip lines originating from the depot. In addition to this, they also incorporate nonlinear charging behavior and battery depreciation using discrete SoC and time nodes in the SDVSP network. They solve using a combination of CG and B\&P. Tests are done on both randomly generated instances as well as 6 not yet electrified lines with up to 160 and 197 trips
respectively.\\
\citet{Parmentier2023} consider a scalable approach to the E-VSP with non-linear charging. They introduce the concept of nondominated charging arcs, which are represented as deadhead arcs within the SDVSP. Their use considerably reduces the amount of candidate charging arcs when multiple charging points are available, as an arc is only considered if there is not another arc available with higher resulting charge and lower cost. In order to solve, a combination of CG and B\&P techniques are used. A more computationally efficient version of the pricing problem is also provided by the nondominated charging arcs when charging
infrastructure is uniform. Testing is done on the \textit{large}
instances introduced by \citet{Wen2016} which included up to 8
depots, 16 charging stations and 500 trips. Here, they are able to find
solutions that only have an 0.06\% optimality gap. \\
% \citet{Pulyassary2024} show that the single depot E-VSP is solvable in polynomial time given the
% assumption that the shortest path between two trips in the flow network is
% equal to the path with lowest battery usage. They
% consider the case in which charging at a select number of capacity bound nodes
% is allowed with nonlinear charging behavior. For the single depot case, a
% $O^*(|T|^6)$ algorithm for finding a set of vehicle schedules with lowest cost
% given trips $T$ is provided based on DP. Additionally, polynomial algorithms
% for determining maximum feasible charging capacity and minimum-cost flows based
% on LP are provided. No computational experiments are performed. \\\\
\citet{deVos2024} consider the E-VSP with partial recharges and capacitated charging stations. Their model includes discrete SoC trip nodes and discrete SoC and time charging location nodes, similar to the model found in \citet{Zhang2021}. Using these, a primal network is created using pessimistic SoC rounding when connecting trips with feasible deadheads. In order to solve, they apply CG with two separate approaches:
branch-and-price and a diving heuristic. To overcome the limitations of dual
bounds resulting from a discretized model, they incorporate ideas from \citet{Boland2017} resulting in a dual network with optimistic connections. This gives the same bounds as the ones found in the
non-discretized model. Testing is performed on a bus concession south of
Amsterdam with 816 trips, with subsets being used as smaller instances.
Optimality gaps of 1.5-2.7\% are achieved across instances. They additionally
note that the framework as provided can easily be extended for nonlinear
charging functions and depth-of-discharge battery degradation. 

\subsection{CSP}
Given a solution to the (E-)VSP, the corresponding CSP is most often solved as a set partitioning (or set covering) problem. Here, the tasks described by the sequences of trips generated during vehicle scheduling must be covered by the individual schedules of crew members. This problem has been shown to be NP-Hard in general by \citet{Fischetti1989}.\\
Research into this subject is primarily done in the context of airline crew planning; crew costs in this field are generally even higher than those found in the more general public transport sector, as shown in \citet{Barnhart2003}. Additionally, strong labor unions and restrictive labor legislation due to safety concerns cause a large number of constraints to be applied to crew schedules, resulting in a non-trivial problem to solve. \\
Results achieved in the aviation space quite easily generalize to other sectors, and we therefore refer the reader to a recent review by \citet{Deveci2018} for an overview of the state of the art. 

\subsection{(E-)VCSP}
The VCSP has been a widely studied problem. Following the call for integrated methods by \citet{Bodin1983} and others in the 1980s, a large number of different methods has been applied to integrate the VSP and CSP. We refer the reader to a recent review by \citet{Ge2024} for a more general overview of work done in the field in the past years. \\
One work that we will individually highlight is that of \citet{Huisman2005}, due to its use of Lagrangian relaxation to connect the VSP and CSP . For readers unfamiliar with the technique, we recommend an introduction by \citet{Beasley1993}. Huisman et al. consider the multi-depot variant, and use a combination of CG and Lagrangian relaxation to solve both the MDVSP as well as the connection with the CSP. Of note is their assumption that crew members from each individual depot are only allowed to work on trips connected to said depot, allowing for individual depot CSPs to be solved as a subproblem. They test on instances in the Randstad metro area in the Netherlands with a maximum of 653 trips and 4 depots. \\\\
As for the electric counterpart of the VCSP, at time of writing we are aware of only five other works that discuss the integrated variant. \\
\citet{Perumal2021} were the first to offer a solution to the E-VCSP. They consider an instance of the problem in which only full recharges at the depot with a fixed duration of
120 minutes are possible. In order to solve, an ALNS was introduced which incorporates a B\&P heuristic
which has been previously used to solve the MDVSP, E-VSP and VCSP. The authors tested using real life data from lines in Denmark and Sweden with a
maximum instance size of 1109 trips and multiple depots, and report an improvement of $1.17-4.37\%$
across different instances when compared to a sequential approach. \\
\citet{Wang2022} introduce a two layered model using particle swarms and an
$\epsilon$-constraint based mechanism which allows for a mix of traditional
combustion and electric buses. The model incorporates partial
depot charging, as well as measures to ensure that crew is primarily assigned
to the same vehicle throughout the day. A circular bus route with a single
depot in Changchun, China with 68 daily trips is used as a basis for testing,
with a focus on electric versus diesel usage and driver satisfaction. \\
\citet{Sistig2023} also offered an ALNS based approach, which aimed to
improve upon the approach presented by \citet{Perumal2021} by including partial
recharges, opportunistic charging at terminal stops of trips and non-fixed
ranges for the vehicles. In order to solve, they implement a
selection of 3-step ALNS neighborhoods consisting of E-VSP modification,
finding a solution to the corresponding CSP and consequently modifying the CSP
solution. Tests were done using an instance of a city route in Germany, with a
single depot and a total of 282 trips. Different scenarios based on possible
crew break and relief locations were considered in order to compare diesel and
electric TCO. Additionally, sensitivity analysis of the TCO was done for
parameters such as costs for electricity and drivers. \\
\citet{Shen2023} provide a minimum-cost flow framework for the E-VSP which is
integrated with a set partitioning based approach for the E-CSP. They only provide full recharge capabilities at the depot,
however focus on the inclusion of a distinction between energy use when driving
and standing still in order to more accurately model real life traffic. A city
line in China with 270 daily trips and a single depot is used for testing,
resulting in cost savings of up to 8.7\% when compared to a sequential
approach. \\
\citet{Cong2024} provide a hybrid MIP and SAA based approach to optimizing a mixed
fleet of combustion and electric vehicles with ToU electricity pricing. In each SAA iteration, a collection of new E-VSP trip
assignments are created using neighborhood operations, after which two MIP
models are sequentially employed to solve for charging and crew schedules. The
methods are tested on a collection of 3 bus routes originating from the same
depot in Changchun City, China with a total of 520 trips across all routes.
When compared to the sequential approach, the integrated vehicle schedule was
able to reduce costs by 0.8\%. 

\subsection{Other related fields}
The VSP is closely related to the vehicle routing problem (VRP); in this problem, the aim is to find minimum cost routes for vehicles originating from a depot and needing to pass multiple stops, most commonly for pickup or delivery with capacity constraints. The extension of the E-VRP which includes arrival time windows (E-VRPTW) is most closely related to the E-VSP, as the use of 0-width windows allows us to define the same precedence constraints as those naturally defined by trips in the VSP. \\
An example of work done on the E-VRPTW is that of \citet{Ham2021}. They consider a single depot case in which they model ToU pricing and partial recharges during delivery routes. In order to model costs, a lexicographical minimization is done over the number of vehicles used, total distance traveled and energy recharged. In order to solve, a hybrid MIP and CP algorithm is used in which CP is used to model ToU related variables, and MIP is used to model the rest of the constraints. \\\\
Research has also been done into integrating the E-VSP with the step before it in the planning sequence: timetable planning. This problem, the E-TVSP, has recently been studied in the work of \citet{Stadnichuk2024}. They allowed results of the E-VSP to introduce optimality cuts into the MIP used for creating timetable plans, thereby reducing overall cost. This is achieved by transforming the E-VSP problem into one of bin packing with conflicts, after which three different heuristic methods are applied and compared. They additionally prove that the bounds of the used heuristics are tight for their given instances. 

\section{Problem definition}
\label{sec:problem_def}
In this section, we will give a definition of the integrated electric vehicle and crew scheduling problem (E-VCSP). As mentioned in previous sections, our goal is to create minimum cost schedules for both vehicles and crew members such that a given set of trips is covered. Before discussing how we define these schedules, we will first formally define the data which is given. \\
Let $T$ be a set of trips that need to be driven, let $D$ be a set of depots that can be used, and let $L$ be a set of locations. A trip is defined as a travel between two locations in $L$; let $l_s(t) \in L$ and $l_e(t) \in L$ represent the starting and ending location of trip $t$ respectively, and let $l(d) \in L$ represent the location of depot $d$. Next, let $p_s(t)$ and $p_e(t)$ refer to the planned starting and ending time of trip $t$, and let $d(t) = p_e(t) - p_s(t)$ be the duration of the trip. Lastly, let $k(t)$ be equal to the number of kilometers traveled during the trip. \\
As multiple vehicles types may be in use, let $\Phi$ represent the set of all vehicle types. For each trip $t$, a subset of these vehicle types $\phi(t) \subseteq \Phi$ may be used in order to drive the trip. Each depot $d$ also has a preallocated number of each vehicle type $\phi \in \Phi$ available; let this be represented by $g(d, \phi) \in \mathbb{N}^+$. Different vehicles might have different battery capacities; let $\sigma_{min}(\phi)$ and $\sigma_{max}(\phi)$ represent the minimal and maximal SoC of vehicle type $\phi$, both expressed in KWh. Additionally, let $\sigma_{start}(\phi)$ represent the capacity that a vehicle starts with at the beginning of a day, and let $c^\phi(t)$ represent the amount of charge a vehicle of type $\phi$ would use when traveling the trip, expressed in KWh. \\
Now, let us define given metrics when traveling between different locations. As the exact travel between locations may differ depending on the time of day (such as longer driving times when dealing with congestion), we will define our metrics based on subtasks instead of locations; this allows us to incorporate the departure time associated with the subtasks.\\
Let $d_m(s, s')$ represent the duration of the drive between $l_e(s)$ and $l_s(s')$, adjusted for departure time. Similarly, let $k_m(s, s')$ represent the amount of kilometers traveled, and let $c^\phi_m(s, s')$ represent the amount of battery charge used. Note that this last metric is dependent on the vehicle type $\phi$, as different vehicle types might have different usage patterns. \\
Lastly, let us define our recharging behavior. In charging behavior, we will make two key assumptions: firstly, we assume that it is only possible for a vehicle to charge between trips. Charging at a depot is therefore not directly modeled unless one of the trip locations is the depot itself. Secondly, we assume charging may only be done at the start of a deadhead; if charging is desired at the end of a deadhead instead, a dummy 0-duration trip must be introduced at the deadhead target to model this behavior. Using these two assumptions, we can determine a maximum amount of charge that can be added during a deadhead from $t$ to $t'$ while still allowing for travel between the two trips. \\
As charging is a nonlinear process, the starting SoC $\sigma$ of a vehicle at $t$ is also of importance, as well as the vehicle type $\phi$. Using all this information, we therefore define $u^\phi_\sigma(t, t')$ as being this maximum possible amount of charge gained in the deadhead from $t$ to $t'$ while still allowing for travel between the trips. Note that when using discrete values for $\sigma$, all values of $u^\phi_\sigma(t, t')$ can be calculated based on the input. \todo{toevoegen locaties, charging, etc} \\\\
Using these given values, we will now start by formally defining a feasible vehicle task for a vehicle of type $\phi$. A vehicle task must start at a depot, then perform a sequence of compatible trips and charging actions, before finally returning to a depot. We will refer to this ordered sequence as $S = \{ s_0, s_1, \dots, s_n, s_{n+1} \}$, where each subtask $s \in S$ can represent one of two actions: driving a trip $t \in T$, or being at a depot $d \in D$. In this sequence, let $a(s) \in \{ depot, trip \}$ represent the specific action that is performed by $s$. In order for a sequence to be a feasible vehicle schedule, the following conditions must be met. \\
First, the vehicle must start at a depot, then perform a sequence of trips, before finally returning to the depot. Note that trips may have starting or ending locations that coincide with that of the depot, however their respective subtask is not considered to be a depot action.
\begin{align}
  a(s_0) &= \text{depot} && \\
  a(s_{n+1}) &= \text{depot} && \\ 
  a(s_i) &= \text{trip} && \forall i = 1, \dots, n
\end{align}
The type of the vehicle must match those allowed for driving a trip. 
\begin{align}
  \phi &\in \phi(t_i) && \forall i = 1, \dots, n
\end{align}
Trips may only be driven sequentially if there is time to travel from one trip to the next. Note that we make the assumption that there is always time to drive to and from a depot at the start and end of the day. 
\begin{align}
  e(s_i) + d(s_i, s_{i+1}) &\leq s(s_{i+1}) && \forall i = 1, \dots, n-1
\end{align}
Lastly, we want to ensure that the battery capacity is always respected. Again, charging can only take place at the end of a trip before traveling to the next trip. \todo{beter verwoorden}.
\begin{align}
  \sigma'_0 &= \sigma_{start}(\phi) \\
  \sigma_{i} &= \sigma'_{i-1} - c^\phi(s_{i-1}, s_{i}) - c(s_{i}) && \forall i = 1, \dots, n + 1 \\
  \sigma_{i} &\geq \sigma_{min}(\phi) && \forall i = 1, \dots, n + 1 \\
  \sigma'_{i} &= \sigma_{i} + \delta_j \cdot u^\phi_{\sigma_{i}}(s_{j}, s_{j+1}) && \forall i = 1, \dots, n \\
  \sigma'_{i} &\leq \sigma_{max}(\phi) && \forall i = 1, \dots, n
\end{align}
Where $\sigma_i$ represents the SoC at the end of subtask $i$, and $\sigma'_i$ represents the SoC after possible charging is done at the end of subtask $i$. Additionally, $0 \leq \delta_i \leq 1$ represents a fraction of the maximum charge received. \\
For a feasible vehicle schedule $v$, let us define the following the following:
\begin{align}
  c(v) &= c(s_0, s_1) + \sum^{n}_{i = 1}(c(s_i) + c(s_i, s_i + 1))  \\
  d(v) &= d(s_0, s_1) + \sum^{n}_{i = 1}(d(s_i) + d(s_i, s_i + 1))  \\
  k(v) &= k(s_0, s_1) + \sum^{n}_{i = 1}(k(s_i) + k(s_i, s_i + 1))  \\
  cost(v) &= \alpha_1 + \alpha_2 \cdot c(v) + \alpha_3 \cdot d(v) + \alpha_4 \cdot k(v) 
\end{align}
Where $c(v)$, $d(v)$ and $k(v)$ represent the total charge used, active time and distance traveled, with some set of scalar values $\alpha$. We will refer to the set of all feasible vehicle tasks as $V$. \\\\
Next, let us consider crew tasks. A crew task $c$ may perform multiple segments of different vehicle tasks, and we will therefore also model our crew tasks on a trip basis. A crew task can therefore once again be defined as a sequence of steps throughout the day of the form $S = \{ s_1, \dots, s_n \}$. We will however now need to incorporate breaks, waiting and handovers as well; we will consider all of these to be steps in this sequence, and will differentiate between action types using $a(s) \in \{\text{ drive, break, wait, step-on, step-off }\}$. In order for a vehicle task to be feasible, the following conditions need to be met. We base our conditions on Dutch labor regulations, however similar regulations are present in other countries as well. \\ 
First, overall time feasibility. A driver may have a duty length of at most 9 hours. \\
\begin{align}
  e(s_n) - s(s_1) \leq 9\text{hours}
\end{align}
Where $s(s)$ and $e(s)$ once again refer to the starting and ending time of a certain step respectively. \\
Next, break time feasibility. For shifts shorter than 4 hours, no breaks are required. For shifts between 4 and 5.5 hours, one break of at least 15 minutes must be included. For shifts longer than 5.5 hours, at least 40 minutes of breaktime must be included, where each individual break must be at least 15 minutes and at least one of these breaks must be 20 minutes or more. Lastly, for shifts starting after 15:00, a break between 16:30 and 20:30 of at least 20 minutes must be included. 
\begin{align}
  &\text{if } 4 \text{ hours} \leq e(s_n) - s(s_1) \leq 5.5 \text{ hours}&\text{ then} && \exists l \in b(S) : d(s) \geq 15 \text{ min} \\
  &\text{if } 5.5 \text{ hours} \leq e(s_n) - s(s_1 &\text{ then} && \forall s \in b(S) : d(s) \geq 15\text{ min } \land \\
  &&&& \exists l \in b(S) : d(s) \geq 20 \text{ min } \land \\
  &&&& \sum_{l \in b(S)}d(s) \geq 40 \text{ min} \\
  &\text{if } s(s_1) \geq \text{15:00} &\text{ then} && \exists s \in b(S) : d(s) \geq 20 \text{ min } \land \\
  &&&& \text{16:30} \leq s(s) \leq \text{20:30} - d(s)  \\
\end{align}
Where $b(S) = \{ s \mid s \in S, a(s) = break \}$ or all break steps within the schedule, and $d(s)$ refers to the duration of the break. \\
Next, we must ensure feasibility regarding transfers between steps themselves. In general, for waiting, break and handover actions, the physical position of the driver does not change. For trips on the other hand, the starting position may differ from the ending position. In order to be feasible, each sequential pair of steps within the schedule must be reachable; additionally, the starting and ending position of the driver must be the same.
\begin{align}
  && g(s_n) = f(s_1) && \\
  && g(s_{i-1}) = f(s_i) && \forall i = 2, \dots, n \\
  \text{if } a(s_i) \neq \text{trip} \text{ then } && g(s_i) = f(s_i) && \forall i = 1, \dots, n
\end{align}
Where $f(s)$ and $g(s)$ refer to the position of the driver at the start and end of $s$ respectively. \\
Handovers between drivers also need to be possible. Drivers may only enter and exit vehicles at certain locations, and doing so costs a specified amount of time at that location. If a driver is already in a vehicle, they may wait inside of that vehicle for the start of a new trip, however breaks cannot be taken in the vehicle itself.
\begin{align}
  &\text{if } a(s_i) = \text{ drive}&\text{ then} && a(s_{i-1}) \in \text{\{ wait, drive, step-on \}} & \land v(s_{i-1}) = v(s_{i}) \\
  &\text{if } a(s_{i-1}) = \text{ drive}&\text{ then} && a(s_{i}) \in \text{\{ wait, drive, step-off \}} & \land v(s_{i-1}) = v(s_{i}) 
\end{align}
With both formulas $\forall i = 2, \dots, n$. Here, $v(s)$ is an identifier for a vehicle that is used in step $s$. Additionally, $p(t)$ specifies the amount of time it takes to get onto a vehicle at the starting location of trip $t$, and $q(t)$ is equal to the amount of time it takes to get off of a vehicle at the end of trip $t$. For steps where handovers are not possible, $p(t) = q(t) = \infty$. \\
Lastly, the schedule must be continuous; the driver must always be performing one of the 5 specified actions, and must start with a step-on and end with a step-off. 
\begin{align}
  a(s_1) &= \text{step-on} && \\
  a(s_n) &= \text{step-off} && \\
  e(s_i-1) &= s(s_i) && \forall i = 2, \dots, n \\
\end{align}
Let $cost(c)$ be defined as some function $\alpha_2 + \beta_2 \cdot (e(s_n) - s(s_n))$, where $\alpha_2$ and $\beta_2$ represent the fixed and variable costs for a crew member respectively. Let the set of all feasible crew schedules be called $C$. \\\\
Now having our definitions of $V$ and $C$, we can formulate our integrated problem. In this, let $x_i$ and $y_i$ indicate the usage of $v_i \in V$ and $c_j \in C$ respectively. Additionally, let $a_it$ indicate that $v_i$ covers trip $t \in T$, and likewise with $b_jt$ for $c_j$.
\begin{align}
\min \quad
& \sum_{1 \leq t \leq |T|} (\sum_{1 \leq i \leq |V|} x_{it}c^v_i + \sum_{1 \leq j \leq |C|} y_{jt}c^c_j)  
\end{align}
Subject to:
\begin{align}
\sum_{1 \leq i \leq |V|} x_{i}a^v_{it} &>= 1 && \forall t = 1,\:\dots,\:|T| \\
\sum_{1 \leq j \leq |C|} y_{j}a^c_{it} &>= 1 && \forall t = 1,\:\dots,\:|T| \\
x_{i} &\in \{ 0, 1 \} && \forall i = 1,\:\dots,\:|V| \\
y_{j} &\in \{ 0, 1 \} && \forall j = 1,\:\dots,\:|C|
\end{align}


\begin{align}
\sum_{1 \leq i \leq |V|} x_{i}a^v_{it} &>= 1 && \forall t = 1,\:\dots,\:|T| \\
\sum_{1 \leq j \leq |C|} y_{j}a^c_{it} &>= 1 && \forall t = 1,\:\dots,\:|T| \\
x_{i} &\in \{ 0, 1 \} && \forall i = 1,\:\dots,\:|V| \\
y_{j} &\in \{ 0, 1 \} && \forall j = 1,\:\dots,\:|C|
\end{align}

\section{Global planning for thesis}
The following constraints list of constraints seem to make the problem the most challenging (when compared to just SDVSP): Partial charges, Nonlinear charges, Battery degradation, Capacitated charging stations, Multiple vehicle types and Multiple depots. Other than that, percentage of used crew shifts must match x type constraints seem like they might make solving harder; I'm unsure of their effects on the results of CG within a set covering context as I haven't seen them mentioned before, however intuitively it seems like it seems like a larger part of the searchspace would need to be traversed in order to find a good solution. \\
Partial charges, nonlinear charges and battery degradation can all be solved by using a similar discrete model as the one used in \citet{vanKootenNiekerk2017}, \citet{Zhang2021} or \citet{deVos2024}; all of these allow for handling of partial and nonlinear in the charging deadhead arcs, and battery degradation can be included during vehicle task column generation. As all of these basically come for free with the choice of modeling, it would seem wise to focus on getting this working first. \\
Next, the addition of capacitated charging stations is an issue. In both \citet{Zhang2021} and \citet{deVos2024}, this is handled by adding even more nodes to the graph which model the individual charging stations, however this only models the number of individual charging spots, and not total charging power available (which is a required constraint in the Qbuzz context). I currently don't have a solution for this in mind yet which remains compatible with nonlinear charging, so some further thought needs to be put into this idea. Depending on results from the initially implemented solution without these shared capacity limits, it might be necessary to focus here next; if it turns out that solutions don't generally exceed charging capacity, it might be worth it to put this off until the end. \\\\
Next, the issue of multiple vehicle types and depots. Both of these can be approached in roughly the same manner, however from conversations with Qbuzz it seems wise to focus on doing vehicle types first as even the smallest instances use multiple vehicle types.\\
In conclusion, my personal guess is that the following list of priorities is the best going forward:
\begin{itemize}
  \item Begin with extending one of the previously mentioned models (probably \cite{vanKootenNiekerk2017}) in order to get solutions to the E-VSP which incorporate partial charging, nonlinear charging and battery degredation.
  \item Add extraction of task blocks for crew scheduling, link with a set cover approach to crew scheduling
  \item If charging capacity turns out to be an issue, start by modifying E-VSP to incorporate this. 
  \item Otherwise, start with adding multiple vehicle types and depots. 
  \item Include charging capacity if not done before. 
\end{itemize}
Rough planning planning of this process is described in Table \ref{tab:planning}. Additionally, weekly meetings with Philip (and Han, however this can also be bi-weekly if this doesn't turn out to be necessary) seem like a good idea to keep a check on progress and motivation. Bi-weekly meetings with Qbuzz are also in the works, in order to validate model and possibly adjust planning if something interesting pops up.
\begin{table}[h]
  \centering
  \begin{tabular}{ll}
    \toprule
    \multicolumn{1}{l}{\textbf{Date}} & \multicolumn{1}{l}{\textbf{Task description}}               \\
    \cmidrule(lr){1-1}\cmidrule(lr){2-2}
    Begin February - Mid February & Finalize proposal \\
    Mid February - Mid March & Implementation of E-SDVSP \\
    Begin March & Proposal Presentation for OR group (if slot available) \\
    Mid March - Begin April & Link E-SDVSP with crew scheduling \\ 
    Begin April - Mid April & Testing with E-SDVCSP, part of report w/ results, hand in draft \\
    Mid April - Mid March & Extend to include multi-vehicle/cap constraints \\
    Mid March - End March & Testing, write part of report, draft \\ 
    End March - End June & Extend to include cap/multi-vehicle constraints \\
    End June - Half July & Testing, write part of report, draft \\
    Half July - End July & Finalize report, prepare for presentation \\ 
    End July / Begin August & Hand in final report, final presentation \\ 
    \bottomrule
  \end{tabular}
  \label{tab:planning}
  \caption{Rough outline of planning}
\end{table}

\printbibliography
\end{document}